#!/bin/bash

# 1. Check for file
if [ -z "$1" ]; then
  echo "Usage: kinetrix filename.kx"
  exit 1
fi

echo "ðŸ”— Step 1: Linking Libraries..."

# DEFINING THE LINKER LOGIC (Safe Mode)
# We pass the filename ($1) into Python as an argument
python3 - "$1" <<END_PYTHON
import sys
import os

# Get the filename from Bash
source_file = sys.argv[1]
lib_path = "/usr/local/lib/kinetrix/libs/"

try:
    with open(source_file, "r") as f:
        lines = f.readlines()

    final_code = ""
    
    for line in lines:
        if line.strip().startswith("include"):
            # Extract filename: include "drive.kx"
            # We split by double quote safely
            parts = line.split("\"")
            if len(parts) > 1:
                lib_name = parts[1]
                full_path = os.path.join(lib_path, lib_name)
                
                # Read the library file
                if os.path.exists(full_path):
                    print(f"   + Including library: {lib_name}")
                    with open(full_path, "r") as lib:
                        final_code += lib.read() + "\n"
                else:
                    print(f"   âŒ Error: Library {lib_name} not found!")
                    sys.exit(1)
        else:
            final_code += line

    # Save the stitched code to a temp file
    with open("linked_code.tmp", "w") as out:
        out.write(final_code)

except Exception as e:
    print(f"Linker Error: {e}")
    sys.exit(1)
END_PYTHON

# Check if linker succeeded
if [ ! -f linked_code.tmp ]; then
    echo "âŒ Linking Failed."
    exit 1
fi

echo "ðŸš€ Step 2: Compiling..."
# Compile the LINKED file, not the original
/usr/local/lib/kinetrix/kcc linked_code.tmp -arduino

if [ ! -f Kinetrix_Arduino.ino ]; then
    echo "âŒ Compilation Failed."
    exit 1
fi

echo "ðŸ“‚ Step 3: Building..."
rm -rf Build_Project
mkdir -p Build_Project
mv Kinetrix_Arduino.ino Build_Project/Build_Project.ino
rm linked_code.tmp

echo "âš¡ Step 4: Flashing..."
~/arduino-cli compile --fqbn arduino:avr:uno Build_Project > /dev/null
~/arduino-cli upload -p /dev/ttyUSB0 --fqbn arduino:avr:uno Build_Project

echo "âœ… Success!"
